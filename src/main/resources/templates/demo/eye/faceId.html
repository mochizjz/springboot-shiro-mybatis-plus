<!DOCTYPE html>
<html  lang="zh" >
<head>
    <meta charset="utf-8">
 	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>人脸核身</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/viewer.css}"   />
    <link rel="stylesheet" type="text/css" th:href="@{/js/faceId/faceId.css}">
    <script src="/js/jquery.min.js"></script>
	<script src="/js/faceId/prefixfree.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="content">
            <div class="messBox">
                <div class="messContent">
                    <input type="text" name="num" id="num" value="240120203016292442104" placeholder="请输入订单号">
                    <input type="text" name="money" id=" money" value="88.88" placeholder="请输入保险金额">
                    <input type="text" name="name" id="name" value="" placeholder="请输入姓名">
                    <input type="text" name="idcard" id="idcard" value="" placeholder="请输入身份证号">
                </div>
            </div>
            <div class="confirm next">
            	<button onclick="goNext(1)">微信验证</button>
            </div>
        </div>
        <div class="upload disnone" style="width: 100%;">
            <div class="messBox">
                <div class="messContent">
                    <!-- 移动端的前置摄像头 -->
                    <input type="file" accept="video/*" capture="camera" id="videoBtn"  style="display:none"/>
                    <div class="move">
                        <p class="tips">请在录制中， &nbsp;&nbsp;做以下动作</p>
                        <h2 class="moveMessage"></h2>
                        <button class="viewer_but" onclick="">查看演示视频</button>
                    </div>
                    <button onclick="takeVideo()">下一步</button>
                </div>
            </div>
        </div>
        <div class="waiting disnone">
            <div class="waitingMsg">系统识别中....</div>
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar">
                        <div class="progress-shadow"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resultBox disnone">
            <div class="icon">
                <img id="icon" src="" alt="">
            </div>
            <div class="resultMsg"></div>
            <div class="resultDesc">请点击下一步继续您的操作</div>
            <button class="nextBut"></button>
        </div>
    </div>
</body>
<script>

/* 检查页面是否在微信里打开 */
var ua = navigator.userAgent.toLowerCase();
if(ua.match(/MicroMessenger/i)=="micromessenger") {
	if(typeof(wx)!='undefined') {
	    wx.miniProgram.getEnv((res)=>{
	        if (res.miniprogram) {
	            alert("在小程序里");
	            wx.miniProgram.navigateTo({url: '/page.wxml'})
	        }else {
	            alert('在微信里')
	        } 
	     })
	}
}else{
   	$('.container').html('<div class="wxMessage">请在微信中查看！</div>')
}
mode();
// 页面跳转
function goNext(num) {
    if (num == 1) {
        $('.upload').toggleClass('disnone').siblings().addClass('disnone');
    }
    if (num == 2) {
        $('.waiting').toggleClass('disnone').siblings().addClass('disnone');
    }
    if (num == 3) {
        $('.resultBox').toggleClass('disnone').siblings().addClass('disnone');
    }
}
// 录制视频
function takeVideo() {
    $('#videoBtn').click();
}
$('body').delegate('#videoBtn','change',function () {
    readURL(this);
})

// 读取视频
var readerFile;
function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
            readerFile = this.result;
            goNext(2);
            result();
        }
        reader.readAsDataURL(input.files[0]);
    }
}

var LiveCode = '', LiveMode = 'ACTION';
// 获取动作数据
function mode() {
    $.ajax({
        url: '/webeye/auth/api/getActionSequence',
        type: 'get',
        dataType: 'json',
        success: function (result) {
        	LiveCode = JSON.parse(result.data).ActionSequence;
            var first = LiveCode.split(',')[0];
            var second = LiveCode.split(',')[1];
            $('.moveMessage').html((first == '1' ? '先张两次嘴，' : '先眨两次眼，') + (second == '2' ? '再眨两次眼' : '再张两次嘴'))
        }
    })
}
// 检测结果
function result() {
    var idcard = $('#idcard').val();
    var name = $('#name').val();

    readerFile = readerFile.replace(/-/g, "+").replace(/_/g, "/")
    var arr = readerFile.substring(readerFile.indexOf(',') + 1);

    var data = {
        "IdCard": idcard,
        "Name": name,
        "VideoBase64": arr,
        "LivenessType": LiveMode,
        "ValidateData": LiveCode
    }
    var fd = new FormData();
    var jsonData = JSON.stringify(data);
    fd.append("jsonData", jsonData);
    
    $.ajax({
        url: '/webeye/auth/api/livenessRecognition',
        type: 'post',
        data: fd,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function (result) {
            goNext(3);
            result = JSON.parse(result.data)
            if (result.Result == 'Success') {
                $('#icon').attr('src', '/img/success.png')
                $('.resultMsg').html('验证成功')
                $('.nextBut').text('下一步')
            } else {
            	$('.resultMsg').html('验证失败')
            	$('.resultDesc').html('错误信息：'+result.Description+'</br>请点击重新操作')
                $('#icon').attr('src', '/img/error.png')
                $('.nextBut').text('重新验证')
                $('.nextBut').click(function () {
                    goNext(1);
                })
            }

        },
        error: function (err) {
            goNext(3);
            $('#icon').attr('src','/img/error.png')
            $('.resultMsg').html('验证失败')
            $('.resultDesc').html('请点击重新操作')
            $('.nextBut').text('重新验证')
            $('.nextBut').click(function () {
                goNext(1);
            })
        }
    })
}

</script>

</html>